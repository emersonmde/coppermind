#!/bin/sh

# Dioxus project pre-commit hook to mirror CI checks.

set -eu

REPO_ROOT="$(git rev-parse --show-toplevel)"
cd "$REPO_ROOT"

echo "â†’ Running cargo fmt -- --check"
cargo fmt -- --check

echo "â†’ Running cargo clippy (core crate)"
cargo clippy -p coppermind-core --all-targets -- -D warnings

echo "â†’ Running cargo clippy (app - web target)"
cargo clippy -p coppermind --target wasm32-unknown-unknown --features web -- -D warnings

echo "â†’ Running cargo clippy (app - desktop target)"
cargo clippy -p coppermind --features desktop --all-targets -- -D warnings

echo "â†’ Running cargo test (core crate)"
cargo test -p coppermind-core --verbose

echo "â†’ Running cargo test (app - desktop)"
cargo test -p coppermind --verbose --features desktop

echo "â†’ Running cargo doc --no-deps"
cargo doc --no-deps

if ! command -v cargo-audit >/dev/null 2>&1; then
  cat <<'EOF' >&2
ðŸš« Missing required tooling: cargo-audit.
Install it once with:
  cargo install cargo-audit --locked
EOF
  exit 1
fi

echo "â†’ Running cargo audit"
cargo audit

if ! command -v dx >/dev/null 2>&1; then
  cat <<'EOF' >&2
ðŸš« Missing required tooling: dioxus-cli (dx).
Install it once with:
  cargo install dioxus-cli --locked
EOF
  exit 1
fi

echo "â†’ Running dx bundle -p coppermind --release (WASM build)"
dx bundle -p coppermind --release

echo "âœ“ All pre-commit checks passed"
